<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Selah – Connecting Bands with Churches</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
    <style>
        .nav-container h1 {
            cursor: pointer;
            transition: opacity 0.3s ease;
        }
        
        .nav-container h1:hover {
            opacity: 0.8;
        }

        .time-slots-container {
            margin: 20px 0;
            padding: 20px;
            background: #f8f9fa;
            border-radius: 10px;
        }

        .time-slots-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(120px, 1fr));
            gap: 10px;
            margin-top: 15px;
        }

        .time-slot {
            padding: 10px;
            border: 2px solid #e9ecef;
            border-radius: 8px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s ease;
            background: white;
            font-weight: 500;
        }

        .time-slot:hover {
            border-color: #007bff;
            background: #f8f9ff;
        }

        .time-slot.selected {
            border-color: #007bff;
            background: #007bff;
            color: white;
        }

        .time-slot.booked {
            border-color: #6c757d;
            background: #6c757d;
            color: white;
            cursor: not-allowed;
            opacity: 0.7;
        }

        .time-slot.pending {
            border-color: #ffc107;
            background: #ffc107;
            color: #212529;
            cursor: not-allowed;
        }

        .time-slot.confirmed {
            border-color: #28a745;
            background: #28a745;
            color: white;
            cursor: not-allowed;
        }

        .selected-time-display {
            background: #e9ecef;
            padding: 15px;
            border-radius: 8px;
            margin: 15px 0;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .selected-time-info {
            font-weight: 500;
            color: #495057;
        }

        .selected-time-info span {
            margin-right: 5px;
        }

        .legend {
            display: flex;
            gap: 20px;
            margin-top: 15px;
            flex-wrap: wrap;
        }

        .legend-item {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 14px;
        }

        .legend-color {
            width: 20px;
            height: 20px;
            border-radius: 4px;
            border: 2px solid #e9ecef;
        }

        .legend-color.available {
            background: white;
            border-color: #e9ecef;
        }

        .legend-color.booked {
            background: #dc3545;
            border-color: #dc3545;
        }

        .legend-color.pending {
            background: #ffc107;
            border-color: #ffc107;
        }

        .legend-color.confirmed {
            background: #28a745;
            border-color: #28a745;
        }

        .legend-color.selected {
            background: #007bff;
            border-color: #007bff;
        }

        .legend-color.range-selected {
            background: #17a2b8;
            border-color: #17a2b8;
        }

        .date-selector {
            margin-bottom: 20px;
        }

        .date-selector input {
            padding: 10px;
            border: 2px solid #e9ecef;
            border-radius: 8px;
            font-size: 16px;
        }

        .loading {
            text-align: center;
            padding: 20px;
            color: #6c757d;
        }

        .no-bookings {
            text-align: center;
            padding: 20px;
            color: #6c757d;
            font-style: italic;
        }
    </style>
</head>
<body>
    <header>
        <nav class="nav-container">
            <h1 onclick="window.location.href='{{ url_for('home') }}'">Selah</h1>
            <ul class="nav-menu">
                <li><a href="{{ url_for('home') }}">홈</a></li>
                {% if 'user_id' in session %}
                    <li><a href="{{ url_for('dashboard') }}">마이페이지</a></li>
                    <li><a href="{{ url_for('logout') }}">로그아웃</a></li>
                {% else %}
                    <li><a href="{{ url_for('login') }}">로그인</a></li>
                    <li><a href="{{ url_for('register') }}">회원가입</a></li>
                {% endif %}
            </ul>
        </nav>
    </header>

    <div class="container">
        <div class="booking-form">
            <h2>{{ church.name }} 예약하기</h2>
            <div class="rate-info">
                시간당 {{ "{:,}".format(church.hourly_rate | int) }}원
            </div>
            
            <form method="POST" id="bookingForm">
                <div class="form-group date-selector">
                    <label for="date">예약 날짜</label>
                    <input type="date" id="date" name="date" min="{{ today }}" required onchange="loadTimeSlots()">
                </div>

                <div class="time-slots-container" id="timeSlotsContainer" style="display: none;">
                    <h3>시간대 선택</h3>
                    <p>시작 시간을 클릭한 후 종료 시간을 클릭해주세요</p>
                    
                    <div class="selected-time-display" id="selectedTimeDisplay" style="display: none;">
                        <div class="selected-time-info">
                            <span>선택된 시간: </span>
                            <span id="startTimeDisplay"></span>
                            <span> ~ </span>
                            <span id="endTimeDisplay"></span>
                        </div>
                        <button type="button" class="btn btn-secondary" onclick="resetTimeSelection()">다시 선택</button>
                    </div>
                    
                    <div class="time-slots-grid" id="timeSlotsGrid">
                        <!-- 시간대가 여기에 동적으로 생성됩니다 -->
                    </div>

                    <div class="legend">
                        <div class="legend-item">
                            <div class="legend-color available"></div>
                            <span>예약 가능</span>
                        </div>
                        <div class="legend-item">
                            <div class="legend-color selected"></div>
                            <span>선택됨</span>
                        </div>
                        <div class="legend-item">
                            <div class="legend-color booked"></div>
                            <span>예약됨</span>
                        </div>
                        <div class="legend-item">
                            <div class="legend-color pending"></div>
                            <span>승인 대기</span>
                        </div>
                        <div class="legend-item">
                            <div class="legend-color confirmed"></div>
                            <span>승인됨</span>
                        </div>
                    </div>
                </div>
                
                <input type="hidden" id="start_time" name="start_time" required>
                <input type="hidden" id="end_time" name="end_time" required>
                
                <div class="form-group">
                    <label for="member_count">인원</label>
                    <select id="member_count" name="member_count" required>
                        <option value="">인원 선택</option>
                        <option value="1">1인</option>
                        <option value="5">5인 이하</option>
                        <option value="10">10인 이하</option>
                        <option value="20">20인 이하</option>
                    </select>
                </div>
                
                <div class="form-group">
                    <label for="payment_method">결제 방법</label>
                    <select id="payment_method" name="payment_method" required>
                        <option value="">결제 방법 선택</option>
                        <option value="계좌이체">계좌이체</option>
                        <option value="교회에 직접 납부">교회에 직접 납부</option>
                        <option value="카드">카드</option>
                    </select>
                </div>
                
                <div class="form-group">
                    <label for="purpose">연습 목적</label>
                    <textarea id="purpose" name="purpose" rows="3" placeholder="연습 목적을 입력해주세요" required></textarea>
                </div>
                
                <div class="form-actions">
                    <button type="submit" class="btn btn-primary">예약하기</button>
                    <a href="{{ url_for('church_detail', church_id=church.id) }}" class="btn btn-secondary">취소</a>
                </div>
            </form>
        </div>
    </div>

    <footer>
        <div class="container" style="text-align:center; padding:2rem 0; color:#555; font-size:1rem;">
            <p><strong>Selah</strong> – 밴드와 교회를 연결하는 연습실 예약 플랫폼</p>
            <p>문의: <a href="mailto:selah.help@gmail.com">selah.help@gmail.com</a> | 02-1234-5678</p>
            <p>
                <a href="#" style="margin:0 0.5rem;">Instagram</a> |
                <a href="#" style="margin:0 0.5rem;">Facebook</a> |
                <a href="#" style="margin:0 0.5rem;">이용약관</a> |
                <a href="#" style="margin:0 0.5rem;">개인정보처리방침</a>
            </p>
            <p style="font-size:0.9em; color:#888; margin-top:1rem;">&copy; 2025 Selah – All rights reserved. Made with ♥ by Selah Team</p>
        </div>
    </footer>

    <script>
        const churchId = parseInt('{{ church.id }}');
        let selectedStartTime = null;
        let selectedEndTime = null;
        let isSelectingStart = true;
        let currentBookings = [];

        function loadTimeSlots() {
            const date = document.getElementById('date').value;
            if (!date) return;

            const container = document.getElementById('timeSlotsContainer');
            const grid = document.getElementById('timeSlotsGrid');
            
            container.style.display = 'block';
            grid.innerHTML = '<div class="loading">시간대 정보를 불러오는 중...</div>';

            fetch(`/api/bookings/${churchId}/${date}`)
                .then(response => response.json())
                .then(bookings => {
                    currentBookings = bookings;
                    displayTimeSlots(bookings);
                })
                .catch(error => {
                    console.error('Error:', error);
                    grid.innerHTML = '<div class="no-bookings">시간대 정보를 불러올 수 없습니다.</div>';
                });
        }

        function displayTimeSlots(bookings) {
            const grid = document.getElementById('timeSlotsGrid');
            const timeSlots = [
                '09:00', '09:30', '10:00', '10:30', '11:00', '11:30', '12:00', '12:30',
                '13:00', '13:30', '14:00', '14:30', '15:00', '15:30', '16:00', '16:30',
                '17:00', '17:30', '18:00', '18:30', '19:00', '19:30', '20:00', '20:30',
                '21:00', '21:30', '22:00'
            ];

            grid.innerHTML = '';

            timeSlots.forEach(time => {
                const slot = document.createElement('div');
                slot.className = 'time-slot';
                slot.textContent = time;
                slot.dataset.time = time;

                // 예약 상태 확인
                const booking = findBookingForTime(bookings, time);
                if (booking) {
                    if (booking.status === 'confirmed') {
                        slot.classList.add('confirmed');
                        slot.title = `예약됨 (${booking.start_time} ~ ${booking.end_time})`;
                    } else if (booking.status === 'pending') {
                        slot.classList.add('pending');
                        slot.title = `승인 대기 (${booking.start_time} ~ ${booking.end_time})`;
                    } else {
                        slot.classList.add('booked');
                        slot.title = `예약됨 (${booking.start_time} ~ ${booking.end_time})`;
                    }
                } else {
                    slot.addEventListener('click', () => handleTimeSlotClick(slot, time));
                }

                grid.appendChild(slot);
            });
        }

        function findBookingForTime(bookings, time) {
            return bookings.find(booking => {
                const start = booking.start_time;
                const end = booking.end_time;
                return time >= start && time < end;
            });
        }

        function handleTimeSlotClick(slot, time) {
            if (isSelectingStart) {
                // 시작 시간 선택
                selectedStartTime = time;
                isSelectingStart = false;
                
                // 이전 선택들 초기화
                clearAllSelections();
                slot.classList.add('selected');
                
                // 안내 메시지 업데이트
                document.querySelector('.time-slots-container p').textContent = '종료 시간을 클릭해주세요';
                
            } else {
                // 종료 시간 선택
                if (time <= selectedStartTime) {
                    alert('종료 시간은 시작 시간보다 늦어야 합니다.');
                    return;
                }
                
                selectedEndTime = time;
                
                // 선택된 시간 표시
                slot.classList.add('selected');
                highlightTimeRange(selectedStartTime, selectedEndTime);
                
                // 선택된 시간 정보 표시
                showSelectedTimeDisplay();
                
                // 폼 필드 업데이트
                document.getElementById('start_time').value = selectedStartTime;
                document.getElementById('end_time').value = selectedEndTime;
                
                // 안내 메시지 업데이트
                document.querySelector('.time-slots-container p').textContent = '시간대 선택이 완료되었습니다';
            }
        }

        function clearAllSelections() {
            document.querySelectorAll('.time-slot').forEach(slot => {
                slot.classList.remove('selected', 'range-selected');
            });
        }

        function highlightTimeRange(startTime, endTime) {
            const slots = document.querySelectorAll('.time-slot');
            slots.forEach(slot => {
                const time = slot.dataset.time;
                if (time > startTime && time < endTime && 
                    !slot.classList.contains('booked') && 
                    !slot.classList.contains('pending') && 
                    !slot.classList.contains('confirmed')) {
                    slot.classList.add('selected');
                }
            });
        }

        function showSelectedTimeDisplay() {
            const display = document.getElementById('selectedTimeDisplay');
            const startDisplay = document.getElementById('startTimeDisplay');
            const endDisplay = document.getElementById('endTimeDisplay');
            
            startDisplay.textContent = selectedStartTime;
            endDisplay.textContent = selectedEndTime;
            display.style.display = 'flex';
        }

        function resetTimeSelection() {
            selectedStartTime = null;
            selectedEndTime = null;
            isSelectingStart = true;
            
            clearAllSelections();
            
            document.getElementById('selectedTimeDisplay').style.display = 'none';
            document.getElementById('start_time').value = '';
            document.getElementById('end_time').value = '';
            
            document.querySelector('.time-slots-container p').textContent = '시작 시간을 클릭한 후 종료 시간을 클릭해주세요';
        }

        // 시간대 선택 시 중복 예약 확인
        function checkTimeConflict(startTime, endTime, bookings) {
            return bookings.some(booking => {
                const bookingStart = booking.start_time;
                const bookingEnd = booking.end_time;
                
                // 시간대가 겹치는지 확인
                return (
                    (startTime <= bookingStart && endTime > bookingStart) ||
                    (startTime < bookingEnd && endTime >= bookingEnd) ||
                    (startTime >= bookingStart && endTime <= bookingEnd)
                );
            });
        }

        // 폼 제출 시 유효성 검사
        document.getElementById('bookingForm').addEventListener('submit', function(e) {
            if (!selectedStartTime || !selectedEndTime) {
                e.preventDefault();
                alert('시간대를 선택해주세요.');
                return;
            }

            // 중복 예약 확인
            if (checkTimeConflict(selectedStartTime, selectedEndTime, currentBookings)) {
                e.preventDefault();
                alert('해당 시간대에 이미 예약이 있습니다. 다른 시간을 선택해주세요.');
                return;
            }
        });
    </script>
</body>
</html>
